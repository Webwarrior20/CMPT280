#!/usr/bin/env python3
"""
SAFE DEMO - Simulated Worm + File Tampering
All actions are confined to TARGET_DIR and reversible.
"""

import os
import shutil
import time
import random
from datetime import datetime
from pathlib import Path

TARGET_DIR = Path(os.environ.get("TARGET_DIR", "/home/victim/assignments")).resolve()
ALLOW_HIDE = os.environ.get("ALLOW_HIDE", "no").lower() == "yes"

EXTS = {".py", ".txt", ".md", ".c", ".java"}
TRASH_DIR = TARGET_DIR / ".trash_demo_backup"
LOGFILE = TARGET_DIR / ".simworm_log.txt"
REPLICA_NAME = "replica_marker.txt"

FAKE_FILE_NAMES = [
    "results.tmp",
    "cache.bak",
    "system32.dll.fake",
    "report_copy.docx.fake",
    "submission_v2.py.bak",
]

FAKE_FILE_CONTENT = "AUTO-GENERATED PLACEHOLDER FILE\nNot harmful.\n"

if "assignments" not in str(TARGET_DIR).lower():
    raise SystemExit("Refusing to run outside safe directory.")

def log(msg):
    TS = datetime.now().isoformat()
    LOGFILE.parent.mkdir(parents=True, exist_ok=True)
    print(f"{TS} | {msg}")
    with open(LOGFILE, "a", encoding="utf-8") as fh:
        fh.write(f"{TS} | {msg}\n")

def find_target_files():
    for root, dirs, files in os.walk(TARGET_DIR):
        if ".trash_demo" in root:
            continue
        for f in files:
            p = Path(root) / f
            if p.suffix.lower() in EXTS:
                yield p

def backup(p: Path):
    TRASH_DIR.mkdir(parents=True, exist_ok=True)
    timestamp = datetime.now().strftime("%Y%m%d_%H%M%S")
    dest = TRASH_DIR / f"{timestamp}_{p.name}"
    shutil.copy2(p, dest)
    return dest

def restore_all():
    if not TRASH_DIR.exists():
        print("No backups found.")
        return
    for backup_file in TRASH_DIR.iterdir():
        if not backup_file.is_file():
            continue
        name = backup_file.name.split("_", 1)[-1].replace(".orig", "")
        restore_path = TARGET_DIR / name
        restore_path.parent.mkdir(parents=True, exist_ok=True)
        shutil.copy2(backup_file, restore_path)
    log("RESTORE COMPLETE")

def replicate_recursive():
    for root, dirs, files in os.walk(TARGET_DIR):
        folder = Path(root)
        dest = folder / REPLICA_NAME
        if not dest.exists():
            with open(dest, "w", encoding="utf-8") as fh:
                fh.write("REPLICA FILE - SAFE DEMO\n")
            log(f"replicated -> {dest}")

def generate_fake_files():
    for name in FAKE_FILE_NAMES:
        fake_path = TARGET_DIR / name
        with open(fake_path, "w", encoding="utf-8") as fh:
            fh.write(FAKE_FILE_CONTENT)
        log(f"created fake file -> {fake_path}")

def light_tamper_code(p: Path):
    backup(p)
    try:
        with open(p, "r", encoding="utf-8") as f:
            content = f.readlines()
    except UnicodeDecodeError:
        return
    content.append(f"# TAMPER_COMMENT: touched at {datetime.now()}\n")
    with open(p, "w", encoding="utf-8") as f:
        f.writelines(content)
    log(f"light_modified {p}")

def main_loop():
    log(f"START - Worm simulated at {TARGET_DIR} (ALLOW_HIDE={ALLOW_HIDE})")
    for cycle in range(1, 4):
        log(f"--- CYCLE {cycle} START ---")
        replicate_recursive()
        generate_fake_files()
        for p in find_target_files():
            if p.name == REPLICA_NAME or p.name == LOGFILE.name:
                continue
            if random.random() < 0.6:
                light_tamper_code(p)
            else:
                backup(p)
        log(f"--- CYCLE {cycle} END ---")
        time.sleep(3)
    log("DONE - Exiting safely")

if __name__ == "__main__":
    if TARGET_DIR.exists():
        main_loop()
    else:
        print("TARGET_DIR not found.")
