#!/usr/bin/env python3
"""
Safe one-shot tampering demo: moves or hides files in TARGET_DIR, then exits.
"""
import os, shutil
from datetime import datetime
from pathlib import Path

TARGET_DIR = Path(os.environ.get("TARGET_DIR", "/home/victim/assignments"))
ALLOW_HIDE = os.environ.get("ALLOW_HIDE", "no").lower() == "yes"
TRASH_DIR = TARGET_DIR / ".trash_demo_backup"
LOGFILE = TARGET_DIR / ".simworm_log.txt"
EXTS = {".py", ".java", ".c", ".txt", ".md"}

def log(msg):
    TS = datetime.now().isoformat()
    with open(LOGFILE, "a", encoding="utf-8") as f:
        f.write(f"{TS} | {msg}\n")
    print(f"{TS} | {msg}")

def main():
    if not TARGET_DIR.exists():
        print(f"Target {TARGET_DIR} not found")
        return
    TRASH_DIR.mkdir(parents=True, exist_ok=True)
    for p in TARGET_DIR.rglob("*"):
        if not p.is_file() or p.suffix not in EXTS:
            continue
        dest = TRASH_DIR / f"{datetime.now().strftime('%Y%m%d_%H%M%S')}_{p.name}"
        try:
            shutil.move(p, dest)
            log(f"moved_to_trash {p} -> {dest}")
        except Exception as e:
            log(f"error_moving {p}: {e}")
    log("one-shot complete")

if __name__ == "__main__":
    main()
